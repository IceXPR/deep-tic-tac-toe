<html>
<header>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css" integrity="sha256-ECB9bbROLGm8wOoEbHcHRxlHgzGqYpDtNTgDTyDz0wg=" crossorigin="anonymous" />

    <style>
        button {
            width: 180px;
            height: 180px;
            vertical-align: top;
            margin:10px;
        }

        #grid {
            width: 600px;
            margin-right: auto;
            margin-left: auto;
        }

        .ai{
            background-color: #33C3F0;
        }

        .player{
            background-color: rgb(240, 196, 51);
        }
    </style>
</header>

<body>

    <div id="app">
        <h2>Deep Tic-Tac-Toe</h2>
        <div id="grid">
            <button v-for="(cell, index) in grid" 
            v-on:click="move(index)" 
            v-bind:class="{ ai: cell==1, player: cell==2}"
            :disabled="cell != 0"
            >
                <span v-if="cell == 1">X</span>
                <span v-else-if="cell == 2">O</span>
                <p>{{Math.round(pred[index]*100)/100 }}</p>
            </button>
        </div>

    </div>

    <script>
        var model;
        tf.loadLayersModel('model/model.json').then((models) => {
            model = models
            console.log('loaded model')
            ai_move()
            // if (callbackOnLoad) {
            //     callbackOnLoad()
            // }
        });

        function predict(x) {

            const input = tf.tensor(x, [1, 3, 3, 2])
            input.print(true)
            const pred = model.predict(input).dataSync()
            Vue.set(app, 'pred', pred)
            return tf.tensor1d(pred).argMax().dataSync()[0]
        }

        function grid_to_input_array(grid) {
            var output = []

         // add AIs positions
         for (var i = 0; i < grid_length; i++) {
                if (grid[i] == 1) {
                    output.push(1);
                    output.push(0);
                }else if (grid[i] == 2){
                    output.push(0);
                    output.push(1);
                } else {
                    output.push(0);
                    output.push(0);
                }
            }
   
            return output
        }

        var grid = [];
        const grid_length = 9;
        for (var i = 0; i < grid_length; i++) {
            grid.push(0);
        }

        function move(button) {
            console.log(button)
            app.grid.splice(button, 1, 2)
            ai_move()
        }

        function ai_move() {

            const pos = predict(grid_to_input_array(app.grid))
            app.grid.splice(pos, 1, 1)
        }

        var app = new Vue({
            el: '#app',
            data: {
                grid: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                pred: []
            }
        })

    </script>

</body>

</html>